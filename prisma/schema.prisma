generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                       String                     @id @default(cuid())
  email                    String                     @unique
  username                 String                     @unique
  passwordHash             String                     @map("password_hash")
  name                     String?
  phone                    String?
  role                     UserRole                   @default(CREW)
  active                   Boolean                    @default(true)
  emailVerified            Boolean                    @default(false) @map("email_verified")
  emailVerificationToken   String?                    @unique @map("email_verification_token")
  emailVerificationExpires DateTime?                  @map("email_verification_expires")
  permissions              String?
  notificationPreferences  String?                    @default("{\"desktopEnabled\":true,\"soundEnabled\":true,\"mentionEnabled\":true}") @map("notification_preferences")
  pushSubscription         String?                    @map("push_subscription") // JSON string of PushSubscription
  dashboardWidgets         String?                    @map("dashboard_widgets") // JSON string of dashboard widget preferences
  createdAt                DateTime                   @default(now()) @map("created_at")
  updatedAt                DateTime                   @updatedAt @map("updated_at")
  yachtId                  String?                    @map("yacht_id")
  alcoholStockHistory      AlcoholStockHistory[]
  createdCashTransactions  CashTransaction[]          @relation("CashTransactionCreator")
  deletedCashTransactions  CashTransaction[]          @relation("CashTransactionDeleter")
  crewDocuments            CrewDocument[]             @relation("CrewDocumentOwner")
  createdCrewDocuments     CrewDocument[]             @relation("CrewDocumentCreator")
  deletedCrewDocuments     CrewDocument[]             @relation("CrewDocumentDeleter")
  approvedExpenses         Expense[]                  @relation("ExpenseApprover")
  createdExpenses          Expense[]                  @relation("ExpenseCreator")
  updatedExpenses          Expense[]                  @relation("ExpenseUpdater")
  deletedExpenses          Expense[]                  @relation("ExpenseDeleter")
  createdExpenseReceipts   ExpenseReceipt[]           @relation("ExpenseReceiptCreator")
  deletedExpenseReceipts   ExpenseReceipt[]           @relation("ExpenseReceiptDeleter")
  createdVesselDocuments   VesselDocument[]           @relation("VesselDocumentCreator")
  deletedVesselDocuments   VesselDocument[]           @relation("VesselDocumentDeleter")
  createdMarinaPermissions MarinaPermissionDocument[] @relation("MarinaPermissionCreator")
  deletedMarinaPermissions MarinaPermissionDocument[] @relation("MarinaPermissionDeleter")
  createdMaintenanceLogs   MaintenanceLog[]           @relation("MaintenanceCreator")
  messageAttachments       MessageAttachment[]        @relation("MessageAttachmentUploader")
  createdChannels          MessageChannel[]           @relation("ChannelCreator")
  readMessages             MessageRead[]              @relation("MessageReader")
  sentMessages             Message[]                  @relation("MessageSender")
  notifications            Notification[]
  createdShoppingLists     ShoppingList[]             @relation("ShoppingListCreator")
  taskAttachments          TaskAttachment[]           @relation("TaskAttachmentUploader")
  taskComments             TaskComment[]              @relation("TaskCommentAuthor")
  assignedTasks            Task[]                     @relation("TaskAssignee")
  completedTasks           Task[]                     @relation("TaskCompleter")
  createdTrips             Trip[]                     @relation("TripCreator")
  completedTripChecklists  TripChecklistItem[]        @relation("TripChecklistCompleter")
  recordedTankLogs         TripTankLog[]              @relation("TripTankLogger")
  recordedMovementLogs     TripMovementLog[]          @relation("TripMovementLogger")
  yacht                    Yacht?                     @relation(fields: [yachtId], references: [id], onDelete: Cascade)
  channels                 MessageChannel[]           @relation("ChannelMembers")
  notes                    UserNote[]
  shifts                   Shift[]                    @relation("ShiftAssignee")
  createdShifts            Shift[]                    @relation("ShiftCreator")
  createdTasks             Task[]                     @relation("TaskCreator")
  leaves                   Leave[]                    @relation("LeaveAssignee")
  createdLeaves            Leave[]                    @relation("LeaveCreator")
  approvedLeaves           Leave[]                    @relation("LeaveApprover")
  customRoleId             String?                    @map("custom_role_id")
  customRole               CustomRole?                @relation(fields: [customRoleId], references: [id], onDelete: SetNull)
  auditLogs                AuditLog[]
  usageEvents              UsageEvent[]
  feedback                 Feedback[]

  @@map("users")
}

model Yacht {
  id                        String                     @id @default(cuid())
  name                      String
  flag                      String?
  length                    Float?
  registrationNumber        String?                    @map("registration_number")
  notes                     String?
  settings                  Json?                      // Tenant settings: currency, measurement system, etc.
  features                  Json?                      // Feature flags: enabled modules
  logoUrl                   String?                    @map("logo_url")
  currentPlanId             String?                    @map("current_plan_id") @db.Uuid
  subscriptionStatus        String?                    @map("subscription_status") // ACTIVE, TRIAL, EXPIRED, etc.
  createdAt                 DateTime                   @default(now()) @map("created_at")
  updatedAt                 DateTime                   @updatedAt @map("updated_at")
  alcoholStocks             AlcoholStock[]
  cashTransactions          CashTransaction[]
  crewDocuments             CrewDocument[]
  expenseCategories         ExpenseCategory[]
  expenses                  Expense[]
  maintenanceLogs           MaintenanceLog[]
  marinaPermissionDocuments MarinaPermissionDocument[]
  messageChannels           MessageChannel[]
  products                  Product[]
  shoppingLists             ShoppingList[]
  shoppingStores            ShoppingStore[]
  tasks                     Task[]
  trips                     Trip[]
  users                     User[]
  vesselDocuments           VesselDocument[]
  shifts                    Shift[]
  leaves                    Leave[]
  customRoles               CustomRole[]
  auditLogs                 AuditLog[]
  usageEvents               UsageEvent[]
  feedback                  Feedback[]
  creditCards               CreditCard[]
  invites                   YachtInvite[]
  currentPlan               Plan?                      @relation(fields: [currentPlanId], references: [id], onDelete: SetNull)

  @@map("yachts")
}

model Trip {
  id              String              @id @default(cuid())
  yachtId         String              @map("yacht_id")
  name            String
  code            String?
  type            TripType            @default(CHARTER) @map("trip_type")
  startDate       DateTime            @map("start_date")
  endDate         DateTime?           @map("end_date")
  departurePort   String?             @map("departure_port")
  arrivalPort     String?             @map("arrival_port")
  status          TripStatus          @default(PLANNED)
  mainGuest       String?             @map("main_guest")
  guestCount      Int?                @map("guest_count")
  notes           String?
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  createdByUserId String?             @map("created_by_user_id")
  expenses        Expense[]
  tasks           Task[]
  itineraryDays   TripItineraryDay[]
  checklists      TripChecklistItem[]
  shoppingLists   ShoppingList[]
  tankLogs        TripTankLog[]
  movementLogs    TripMovementLog[]
  createdBy       User?               @relation("TripCreator", fields: [createdByUserId], references: [id])
  yacht           Yacht               @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([yachtId, startDate])
  @@index([yachtId, status])
  @@map("trips")
}

model TripItineraryDay {
  id           String    @id @default(cuid())
  tripId       String    @map("trip_id")
  dayIndex     Int       @map("day_index")
  date         DateTime?
  fromLocation String?   @map("from_location")
  toLocation   String?   @map("to_location")
  activities   String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  trip         Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@map("trip_itinerary_days")
}

model TripChecklistItem {
  id            String            @id @default(cuid())
  tripId        String            @map("trip_id")
  type          TripChecklistType @map("type")
  title         String
  remarks       String?
  completed     Boolean           @default(false)
  completedAt   DateTime?         @map("completed_at")
  completedById String?           @map("completed_by_id")
  orderIndex    Int               @default(0) @map("order_index")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  completedBy   User?             @relation("TripChecklistCompleter", fields: [completedById], references: [id], onDelete: SetNull)
  trip          Trip              @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId, type])
  @@map("trip_checklist_items")
}

model TripTankLog {
  id           String   @id @default(cuid())
  tripId       String   @map("trip_id")
  fuelLevel    Float?   @map("fuel_level")
  freshWater   Float?   @map("fresh_water")
  greyWater    Float?   @map("grey_water")
  blackWater   Float?   @map("black_water")
  notes        String?
  recordedAt   DateTime @default(now()) @map("recorded_at")
  recordedById String?  @map("recorded_by_id")
  trip         Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  recordedBy   User?    @relation("TripTankLogger", fields: [recordedById], references: [id], onDelete: SetNull)

  @@index([tripId])
  @@map("trip_tank_logs")
}

model TripMovementLog {
  id           String            @id @default(cuid())
  tripId       String            @map("trip_id")
  eventType    TripMovementEvent @map("event_type")
  port         String?
  eta          DateTime?         @map("eta")
  etd          DateTime?         @map("etd")
  weather      String?
  seaState     String?           @map("sea_state")
  notes        String?
  recordedAt   DateTime          @default(now()) @map("recorded_at")
  recordedById String?           @map("recorded_by_id")
  trip         Trip              @relation(fields: [tripId], references: [id], onDelete: Cascade)
  recordedBy   User?             @relation("TripMovementLogger", fields: [recordedById], references: [id], onDelete: SetNull)

  @@index([tripId])
  @@map("trip_movement_logs")
}

model Task {
  id              String           @id @default(cuid())
  yachtId         String           @map("yacht_id")
  tripId          String?          @map("trip_id")
  title           String
  description     String?
  assigneeId      String?          @map("assignee_id")
  assigneeRole    UserRole?        @map("assignee_role")
  completedById   String?          @map("completed_by_id")
  completedAt     DateTime?        @map("completed_at")
  dueDate         DateTime?        @map("due_date")
  status          TaskStatus       @default(TODO)
  priority        TaskPriority     @default(MEDIUM)
  type            TaskType         @default(GENERAL)
  cost            Float?
  currency        String?          @default("EUR")
  serviceProvider String?          @map("service_provider")
  createdByUserId String?          @map("created_by_user_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  notifications   Notification[]
  attachments     TaskAttachment[]
  comments        TaskComment[]
  assignee        User?            @relation("TaskAssignee", fields: [assigneeId], references: [id])
  completedBy     User?            @relation("TaskCompleter", fields: [completedById], references: [id])
  createdBy       User?            @relation("TaskCreator", fields: [createdByUserId], references: [id])
  trip            Trip?            @relation(fields: [tripId], references: [id])
  yacht           Yacht            @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([yachtId, status])
  @@index([yachtId, assigneeRole, status])
  @@index([assigneeId, status])
  @@index([dueDate])
  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)

  @@map("task_comments")
}

model TaskAttachment {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  fileName  String   @map("file_name")
  fileUrl   String   @map("file_url")
  fileSize  Int?     @map("file_size")
  mimeType  String?  @map("mime_type")
  createdAt DateTime @default(now()) @map("created_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskAttachmentUploader", fields: [userId], references: [id], onDelete: Cascade)

  @@map("task_attachments")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType
  taskId    String?          @map("task_id")
  messageId String?          @map("message_id")
  content   String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")
  message   Message?         @relation(fields: [messageId], references: [id], onDelete: Cascade)
  task      Task?            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([taskId])
  @@map("notifications")
}

model ExpenseCategory {
  id        String    @id @default(cuid())
  yachtId   String    @map("yacht_id")
  name      String
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  yacht     Yacht     @relation(fields: [yachtId], references: [id], onDelete: Cascade)
  expenses  Expense[]

  @@unique([yachtId, name])
  @@map("expense_categories")
}

model CreditCard {
  id                String    @id @default(cuid())
  yachtId           String    @map("yacht_id")
  ownerName         String    @map("owner_name")
  lastFourDigits    String    @map("last_four_digits")
  billingCycleEndDate Int?    @map("billing_cycle_end_date") // Day of month (1-31)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")
  expenses          Expense[]
  yacht             Yacht     @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@index([yachtId, deletedAt])
  @@map("credit_cards")
}

model Expense {
  id                 String            @id @default(cuid())
  yachtId            String            @map("yacht_id")
  tripId             String?           @map("trip_id")
  createdByUserId    String            @map("created_by_user_id")
  approvedByUserId   String?           @map("approved_by_user_id")
  updatedByUserId    String?           @map("updated_by_user_id")
  deletedByUserId    String?           @map("deleted_by_user_id")
  status             ExpenseStatus     @default(DRAFT)
  date               DateTime
  categoryId         String            @map("category_id")
  description        String
  amount             Float
  currency           String            @default("EUR")
  exchangeRateToBase Float?            @map("exchange_rate_to_base")
  baseAmount         Float?            @map("base_amount")
  paymentMethod      PaymentMethod     @map("payment_method")
  paidBy             PaidBy            @map("paid_by")
  creditCardId       String?           @map("credit_card_id")
  vendorName         String?           @map("vendor_name")
  invoiceNumber      String?           @map("invoice_number")
  vatRate            Float?            @map("vat_rate")
  vatAmount          Float?            @map("vat_amount")
  totalAmountWithVat Float?            @map("total_amount_with_vat")
  isReimbursable     Boolean           @default(false) @map("is_reimbursable")
  isReimbursed       Boolean           @default(false) @map("is_reimbursed")
  reimbursedAt       DateTime?         @map("reimbursed_at")
  notes              String?
  deletedAt          DateTime?         @map("deleted_at")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  cashTransactions   CashTransaction[]
  receipts           ExpenseReceipt[]
  approvedBy         User?             @relation("ExpenseApprover", fields: [approvedByUserId], references: [id])
  updatedBy          User?             @relation("ExpenseUpdater", fields: [updatedByUserId], references: [id])
  deletedBy          User?             @relation("ExpenseDeleter", fields: [deletedByUserId], references: [id])
  category           ExpenseCategory   @relation(fields: [categoryId], references: [id])
  createdBy          User              @relation("ExpenseCreator", fields: [createdByUserId], references: [id])
  trip               Trip?             @relation(fields: [tripId], references: [id])
  yacht              Yacht             @relation(fields: [yachtId], references: [id], onDelete: Cascade)
  creditCard         CreditCard?       @relation(fields: [creditCardId], references: [id])

  @@index([deletedAt])
  @@index([yachtId, status, deletedAt])
  @@index([yachtId, date, deletedAt])
  @@index([createdByUserId, status])
  @@index([isReimbursable, isReimbursed])
  @@index([yachtId, isReimbursable, isReimbursed, deletedAt])
  @@map("expenses")
}

model ExpenseReceipt {
  id              String    @id @default(cuid())
  expenseId       String    @map("expense_id")
  fileUrl         String?   @map("file_url") // Nullable for new uploads (legacy base64 fallback)
  storageBucket   String?   @map("storage_bucket") // Supabase Storage bucket name
  storagePath     String?   @map("storage_path") // File path in bucket
  mimeType        String?   @map("mime_type") // MIME type
  fileSize        Int?      @map("file_size") // File size in bytes
  uploadedAt      DateTime  @default(now()) @map("uploaded_at")
  createdByUserId String?   @map("created_by_user_id")
  deletedByUserId String?   @map("deleted_by_user_id")
  deletedAt       DateTime? @map("deleted_at")
  expense         Expense   @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  createdBy       User?     @relation("ExpenseReceiptCreator", fields: [createdByUserId], references: [id])
  deletedBy       User?     @relation("ExpenseReceiptDeleter", fields: [deletedByUserId], references: [id])

  @@index([deletedAt])
  @@index([storageBucket, storagePath])
  @@map("expense_receipts")
}

model CashTransaction {
  id              String              @id @default(cuid())
  yachtId         String              @map("yacht_id")
  type            CashTransactionType
  amount          Float
  currency        String              @default("EUR")
  description     String?
  expenseId       String?             @map("expense_id")
  createdByUserId String              @map("created_by_user_id")
  deletedByUserId String?             @map("deleted_by_user_id")
  deletedAt       DateTime?           @map("deleted_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  createdBy       User                @relation("CashTransactionCreator", fields: [createdByUserId], references: [id])
  deletedBy       User?               @relation("CashTransactionDeleter", fields: [deletedByUserId], references: [id])
  expense         Expense?            @relation(fields: [expenseId], references: [id])
  yacht           Yacht               @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("cash_transactions")
}

model MarinaPermissionDocument {
  id              String    @id @default(cuid())
  yachtId         String    @map("yacht_id")
  title           String
  fileUrl         String    @map("file_url")
  notes           String?
  expiryDate      DateTime? @map("expiry_date")
  createdByUserId String?   @map("created_by_user_id")
  deletedByUserId String?   @map("deleted_by_user_id")
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  yacht           Yacht     @relation(fields: [yachtId], references: [id], onDelete: Cascade)
  createdBy       User?     @relation("MarinaPermissionCreator", fields: [createdByUserId], references: [id])
  deletedBy       User?     @relation("MarinaPermissionDeleter", fields: [deletedByUserId], references: [id])

  @@index([deletedAt])
  @@index([yachtId, expiryDate, deletedAt])
  @@map("marina_permission_documents")
}

model VesselDocument {
  id              String    @id @default(cuid())
  yachtId         String    @map("yacht_id")
  title           String
  fileUrl         String?   @map("file_url") // Nullable for new uploads (legacy base64 fallback)
  storageBucket   String?   @map("storage_bucket") // Supabase Storage bucket name
  storagePath     String?   @map("storage_path") // File path in bucket
  mimeType        String?   @map("mime_type") // MIME type
  fileSize        Int?      @map("file_size") // File size in bytes
  notes           String?
  expiryDate      DateTime? @map("expiry_date")
  createdByUserId String?   @map("created_by_user_id")
  deletedByUserId String?   @map("deleted_by_user_id")
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  yacht           Yacht     @relation(fields: [yachtId], references: [id], onDelete: Cascade)
  createdBy       User?     @relation("VesselDocumentCreator", fields: [createdByUserId], references: [id])
  deletedBy       User?     @relation("VesselDocumentDeleter", fields: [deletedByUserId], references: [id])

  @@index([deletedAt])
  @@index([storageBucket, storagePath])
  @@map("vessel_documents")
}

model UserNote {
  id        String                  @id @default(cuid())
  userId    String                  @map("user_id")
  title     String
  content   Json                    @db.JsonB
  createdAt DateTime                @default(now()) @map("created_at")
  updatedAt DateTime                @updatedAt @map("updated_at")
  user      User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  checklist UserNoteChecklistItem[]

  @@index([userId])
  @@map("user_notes")
}

model UserNoteChecklistItem {
  id        String   @id @default(cuid())
  noteId    String   @map("note_id")
  content   String
  completed Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  note      UserNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@map("user_note_checklist_items")
}

model CrewDocument {
  id              String    @id @default(cuid())
  yachtId         String    @map("yacht_id")
  userId          String?   @map("user_id")
  title           String
  fileUrl         String?   @map("file_url") // Nullable for new uploads (legacy base64 fallback)
  storageBucket   String?   @map("storage_bucket") // Supabase Storage bucket name
  storagePath     String?   @map("storage_path") // File path in bucket
  mimeType        String?   @map("mime_type") // MIME type
  fileSize        Int?      @map("file_size") // File size in bytes
  notes           String?
  expiryDate      DateTime? @map("expiry_date")
  createdByUserId String?   @map("created_by_user_id")
  deletedByUserId String?   @map("deleted_by_user_id")
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  user            User?     @relation("CrewDocumentOwner", fields: [userId], references: [id])
  createdBy       User?     @relation("CrewDocumentCreator", fields: [createdByUserId], references: [id])
  deletedBy       User?     @relation("CrewDocumentDeleter", fields: [deletedByUserId], references: [id])
  yacht           Yacht     @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@index([storageBucket, storagePath])
  @@map("crew_documents")
}

model MessageChannel {
  id              String    @id @default(cuid())
  yachtId         String    @map("yacht_id")
  name            String
  description     String?
  isGeneral       Boolean   @default(false) @map("is_general")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  createdByUserId String?   @map("created_by_user_id")
  createdBy       User?     @relation("ChannelCreator", fields: [createdByUserId], references: [id])
  yacht           Yacht     @relation(fields: [yachtId], references: [id], onDelete: Cascade)
  messages        Message[]
  members         User[]    @relation("ChannelMembers")

  @@unique([yachtId, name])
  @@map("message_channels")
}

model Message {
  id              String              @id @default(cuid())
  channelId       String              @map("channel_id")
  userId          String              @map("user_id")
  content         String?
  imageUrl        String?             @map("image_url") // Nullable for new uploads (legacy base64 fallback)
  imageBucket     String?             @map("image_bucket") // Supabase Storage bucket name
  imagePath       String?             @map("image_path") // File path in bucket
  imageMimeType   String?             @map("image_mime_type") // MIME type
  imageSize       Int?                @map("image_size") // File size in bytes
  parentMessageId String?             @map("parent_message_id")
  isPinned        Boolean             @default(false) @map("is_pinned")
  editedAt        DateTime?           @map("edited_at")
  deletedAt       DateTime?           @map("deleted_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  attachments     MessageAttachment[]
  reads           MessageRead[]
  channel         MessageChannel      @relation(fields: [channelId], references: [id], onDelete: Cascade)
  parentMessage   Message?            @relation("MessageReplies", fields: [parentMessageId], references: [id], onDelete: Cascade)
  replies         Message[]           @relation("MessageReplies")
  user            User                @relation("MessageSender", fields: [userId], references: [id], onDelete: Cascade)
  notifications   Notification[]

  @@index([channelId, deletedAt, createdAt])
  @@index([channelId, parentMessageId])
  @@index([imageBucket, imagePath])
  @@map("messages")
}

model MessageRead {
  id        String   @id @default(cuid())
  messageId String   @map("message_id")
  userId    String   @map("user_id")
  readAt    DateTime @default(now()) @map("read_at")
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation("MessageReader", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@map("message_reads")
}

model MessageAttachment {
  id            String   @id @default(cuid())
  messageId     String   @map("message_id")
  userId        String   @map("user_id")
  fileName      String   @map("file_name")
  fileUrl       String?  @map("file_url") // Nullable for new uploads (legacy base64 fallback)
  storageBucket String?  @map("storage_bucket") // Supabase Storage bucket name
  storagePath   String?  @map("storage_path") // File path in bucket
  fileSize      Int?     @map("file_size")
  mimeType      String?  @map("mime_type")
  createdAt     DateTime @default(now()) @map("created_at")
  message       Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user          User     @relation("MessageAttachmentUploader", fields: [userId], references: [id], onDelete: Cascade)

  @@index([storageBucket, storagePath])
  @@map("message_attachments")
}

model Product {
  id          String         @id @default(cuid())
  yachtId     String         @map("yacht_id")
  name        String
  defaultUnit ItemUnit       @default(PIECE) @map("default_unit")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  yacht       Yacht          @relation(fields: [yachtId], references: [id], onDelete: Cascade)
  items       ShoppingItem[]

  @@unique([yachtId, name])
  @@map("products")
}

model ShoppingStore {
  id            String         @id @default(cuid())
  yachtId       String         @map("yacht_id")
  name          String
  type          StoreType
  address       String?
  phone         String?
  notes         String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  shoppingLists ShoppingList[]
  yacht         Yacht          @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@unique([yachtId, name])
  @@map("shopping_stores")
}

model ShoppingList {
  id              String             @id @default(cuid())
  yachtId         String             @map("yacht_id")
  storeId         String?            @map("store_id")
  tripId          String?            @map("trip_id")
  name            String
  description     String?
  status          ShoppingListStatus @default(DRAFT)
  createdByUserId String?            @map("created_by_user_id")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  items           ShoppingItem[]
  createdBy       User?              @relation("ShoppingListCreator", fields: [createdByUserId], references: [id])
  store           ShoppingStore?     @relation(fields: [storeId], references: [id])
  trip            Trip?              @relation(fields: [tripId], references: [id], onDelete: SetNull)
  yacht           Yacht              @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@map("shopping_lists")
}

model ShoppingItem {
  id          String       @id @default(cuid())
  listId      String       @map("list_id")
  productId   String?      @map("product_id")
  name        String
  quantity    Float
  unit        ItemUnit
  storeId     String?      @map("store_id")
  storeName   String?      @map("store_name")
  isCompleted Boolean      @default(false) @map("is_completed")
  notes       String?
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  list        ShoppingList @relation(fields: [listId], references: [id], onDelete: Cascade)
  product     Product?     @relation(fields: [productId], references: [id])

  @@map("shopping_items")
}

model AlcoholStock {
  id                String                @id @default(cuid())
  yachtId           String                @map("yacht_id")
  name              String
  category          AlcoholCategory?
  quantity          Float                 @default(0)
  unit              String                @default("bottle")
  lowStockThreshold Float?                @map("low_stock_threshold")
  notes             String?
  imageUrl          String?               @map("image_url")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  history           AlcoholStockHistory[]
  yacht             Yacht                 @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@unique([yachtId, name])
  @@index([yachtId, lowStockThreshold])
  @@index([yachtId, quantity])
  @@map("alcohol_stocks")
}

model AlcoholStockHistory {
  id             String       @id @default(cuid())
  stockId        String       @map("stock_id")
  userId         String?      @map("user_id")
  changeType     String       @map("change_type")
  quantityBefore Float        @map("quantity_before")
  quantityAfter  Float        @map("quantity_after")
  quantityChange Float        @map("quantity_change")
  notes          String?
  createdAt      DateTime     @default(now()) @map("created_at")
  stock          AlcoholStock @relation(fields: [stockId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id])

  @@map("alcohol_stock_history")
}

model MaintenanceLog {
  id              String                @id @default(cuid())
  yachtId         String                @map("yacht_id")
  type            MaintenanceType
  title           String
  description     String?
  component       String?
  serviceProvider String?               @map("service_provider")
  cost            Float?
  currency        String                @default("EUR")
  date            DateTime
  nextDueDate     DateTime?             @map("next_due_date")
  mileage         Float?
  mileageUnit     String?               @map("mileage_unit")
  notes           String?
  createdByUserId String?               @map("created_by_user_id")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  documents       MaintenanceDocument[]
  createdBy       User?                 @relation("MaintenanceCreator", fields: [createdByUserId], references: [id])
  yacht           Yacht                 @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([yachtId, nextDueDate])
  @@index([yachtId, date])
  @@map("maintenance_logs")
}

model MaintenanceDocument {
  id            String         @id @default(cuid())
  maintenanceId String         @map("maintenance_id")
  fileUrl       String         @map("file_url")
  title         String?
  uploadedAt    DateTime       @default(now()) @map("uploaded_at")
  maintenance   MaintenanceLog @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)

  @@map("maintenance_documents")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  OWNER
  CAPTAIN
  CHEF
  STEWARDESS
  DECKHAND
  ENGINEER
  CREW
}

enum TripStatus {
  PLANNED
  ONGOING
  COMPLETED
  CANCELLED
}

enum TripType {
  CHARTER
  PRIVATE
  DELIVERY
  MAINTENANCE
  OTHER
}

enum TaskStatus {
  TODO
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskType {
  GENERAL
  MAINTENANCE
  REPAIR
  INSPECTION
}

enum ExpenseStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  OWNER_ACCOUNT
  OTHER
}

enum PaidBy {
  VESSEL
  OWNER
  CHARTERER
  CREW_PERSONAL
}

enum StoreType {
  MARKET
  BUTCHER
  GROCERY
  DELI
  BAKERY
  FISH_MARKET
  PHARMACY
  OTHER
}

enum ShoppingListStatus {
  DRAFT
  ACTIVE
  COMPLETED
}

enum ItemUnit {
  PIECE
  KG
  LITER
  GRAM
  PACK
  BOX
  BOTTLE
  OTHER
}

enum MaintenanceType {
  PREVENTIVE
  REPAIR
  INSPECTION
  UPGRADE
  EMERGENCY
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_COMPLETED
  TASK_DUE_SOON
  TASK_OVERDUE
  MESSAGE_MENTION
  MESSAGE_RECEIVED
  SHOPPING_LIST_COMPLETED
}

enum CashTransactionType {
  DEPOSIT
  WITHDRAWAL
}

enum AlcoholCategory {
  WINE
  SPIRITS
  BEER
}

enum TripChecklistType {
  PRE_DEPARTURE
  POST_ARRIVAL
}

enum TripMovementEvent {
  DEPARTURE
  ARRIVAL
}

model Shift {
  id              String    @id @default(cuid())
  yachtId         String    @map("yacht_id")
  userId          String    @map("user_id")
  date            DateTime
  startTime       DateTime  @map("start_time")
  endTime         DateTime  @map("end_time")
  type            ShiftType
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  createdByUserId String?   @map("created_by_user_id")
  createdBy       User?     @relation("ShiftCreator", fields: [createdByUserId], references: [id])
  user            User      @relation("ShiftAssignee", fields: [userId], references: [id], onDelete: Cascade)
  yacht           Yacht     @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([yachtId, date])
  @@index([userId, date])
  @@map("shifts")
}

enum ShiftType {
  MORNING
  AFTERNOON
  NIGHT
  FULL_DAY
  ON_CALL
}

model Leave {
  id               String      @id @default(cuid())
  yachtId          String      @map("yacht_id")
  userId           String      @map("user_id")
  startDate        DateTime    @map("start_date")
  endDate          DateTime    @map("end_date")
  type             LeaveType
  reason           String?
  status           LeaveStatus @default(PENDING)
  approvedByUserId String?     @map("approved_by_user_id")
  approvedBy       User?       @relation("LeaveApprover", fields: [approvedByUserId], references: [id])
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  createdByUserId  String?     @map("created_by_user_id")
  createdBy        User?       @relation("LeaveCreator", fields: [createdByUserId], references: [id])
  user             User        @relation("LeaveAssignee", fields: [userId], references: [id], onDelete: Cascade)
  yacht            Yacht       @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([yachtId, startDate, endDate])
  @@index([userId, startDate, endDate])
  @@map("leaves")
}

enum LeaveType {
  ANNUAL_LEAVE
  SICK_LEAVE
  PERSONAL_LEAVE
  EMERGENCY_LEAVE
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

model CustomRole {
  id          String   @id @default(cuid())
  yachtId     String   @map("yacht_id")
  name        String
  description String?
  permissions String // JSON array of permissions
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  yacht       Yacht    @relation(fields: [yachtId], references: [id], onDelete: Cascade)
  users       User[]

  @@unique([yachtId, name])
  @@index([yachtId, active])
  @@map("custom_roles")
}

model AuditLog {
  id          String      @id @default(cuid())
  yachtId     String      @map("yacht_id")
  userId      String      @map("user_id")
  action      AuditAction
  entityType  String      @map("entity_type")
  entityId    String      @map("entity_id")
  changes     Json?       @db.JsonB
  description String?
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  createdAt   DateTime    @default(now()) @map("created_at")
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  yacht       Yacht       @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([yachtId, entityType, entityId])
  @@index([yachtId, createdAt])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
  APPROVE
  REJECT
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

model YachtInvite {
  id        String       @id @default(cuid())
  email     String
  name      String?
  role      UserRole
  yachtId   String       @map("yacht_id")
  token     String       @unique
  expiresAt DateTime     @map("expires_at")
  status    InviteStatus @default(PENDING)
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  yacht     Yacht        @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@unique([yachtId, email, status])
  @@index([token])
  @@index([yachtId, status])
  @@index([email, status])
  @@index([expiresAt])
  @@map("yacht_invites")
}

model UsageEvent {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  yachtId   String?  @map("yacht_id")
  eventType String   @map("event_type") // "page_view", "action", "error"
  page      String? // Page path (e.g., "/dashboard/expenses")
  action    String? // Action name (e.g., "expense.create", "task.complete")
  metadata  Json?    @db.JsonB // Additional context
  createdAt DateTime @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  yacht Yacht? @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([yachtId, createdAt])
  @@index([eventType, createdAt])
  @@index([page, createdAt])
  @@map("usage_events")
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  yachtId   String?  @map("yacht_id")
  type      String // "bug", "feature", "question", "other"
  page      String? // Page where feedback was submitted
  action    String? // Action context (e.g., "expense.create")
  message   String
  metadata  Json?    @db.JsonB // Additional context
  status    String   @default("new") // "new", "reviewed", "resolved"
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  yacht Yacht? @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([yachtId, createdAt])
  @@index([status, createdAt])
  @@map("feedback")
}

model Plan {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String   @unique
  features     String[] // Array of feature keys (e.g., ["module:logbook", "module:finance"])
  limits       Json?    // Numeric limits (e.g., { "max_users": 5, "storage_mb": 2048 })
  monthlyPrice Float?   @map("monthly_price")
  annualPrice  Float?   @map("annual_price")
  currency     String   @default("USD")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz
  yachts       Yacht[]

  @@map("plans")
}
